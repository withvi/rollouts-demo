version: 2.1

orbs:
    docker: circleci/docker@1.0.1

jobs:
    prepare-dependencies:
        docker:
            - image: node:current-alpine
              auth:
                username: $DOCKERHUB_USERNAME
                password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
        steps:
            - checkout
            - run: echo "this is prepare-dependencies job"

    build-production:
        docker:
            - image: node:current-alpine
              auth:
                username: $DOCKERHUB_USERNAME
                password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
        steps:
            - run: echo "this is build-production job"

    build-docker-image:
        machine:
            # The image uses the current tag, which always points to the most recent
            # supported release. If stability and determinism are crucial for your CI
            # pipeline, use a release date tag with your image, e.g. ubuntu-2004:202201-02
            image: ubuntu-2004:current
        steps:
            - run: echo "this is build-docker-image job"

    test:
        docker:
            - image: node:current-alpine
              auth:
                username: $DOCKERHUB_USERNAME
                password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
        parallelism: 2
        steps:
            - run: echo "this is test job"

    deploy-docker-image:
        machine:
            image: ubuntu-2004:current
        steps:
            - run: echo "this is deploy-docker-image job"

workflows:
    version: 2
    build-test-deploy:
        jobs:
            - prepare-dependencies
            - build-production:
                  requires:
                      - prepare-dependencies
            - build-docker-image:
                  context: docker-hub
                  requires:
                      - build-production
            - test:
                  requires:
                      - prepare-dependencies
            - deploy-docker-image:
                  context: docker-hub
                  requires:
                      - build-docker-image
                      - test

# Test